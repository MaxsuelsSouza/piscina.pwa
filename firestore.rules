rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Função helper para verificar se o usuário é admin
    function isAdmin() {
      return request.auth != null && request.auth.uid == 'X7aWBsKSpkTQr25mAigi9DkGULG3';
    }

    // Função helper para verificar se está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Função helper para verificar se o usuário é o dono do recurso
    function isOwner(ownerId) {
      return request.auth != null && request.auth.uid == ownerId;
    }

    // Função helper para verificar se é admin ou dono
    function isAdminOrOwner(ownerId) {
      return isAdmin() || isOwner(ownerId);
    }

    // Regras para agendamentos (bookings)
    match /bookings/{bookingId} {
      // Leitura individual (get):
      // - Admin: pode ler tudo
      // - Cliente autenticado: apenas agendamentos com seu ownerId
      // - Público não autenticado: pode ler agendamentos com ownerId (para páginas públicas)
      allow get: if isAdmin() ||
                    (isAuthenticated() && 'ownerId' in resource.data && isOwner(resource.data.ownerId)) ||
                    (!isAuthenticated() && 'ownerId' in resource.data);

      // Leitura de lista (queries):
      // - Admin: pode ler tudo
      // - Cliente autenticado: pode ler apenas seus agendamentos (ownerId)
      // - Público não autenticado: pode ler com limite (para páginas públicas de agendamento)
      // IMPORTANTE: Clientes públicos usam API routes para buscar seus agendamentos
      allow list: if isAdmin() ||
                     (isAuthenticated() && resource.data.ownerId == request.auth.uid) ||
                     (!isAuthenticated() && request.query.limit <= 100);

      // Criação:
      // - Admin: pode criar com qualquer ownerId
      // - Cliente autenticado: pode criar com seu próprio ownerId
      // - Público: pode criar agendamentos para um cliente específico (com ownerId)
      allow create: if isAdmin() ||
                       (isAuthenticated() && 'ownerId' in request.resource.data && request.resource.data.ownerId == request.auth.uid) ||
                       (!isAuthenticated() && 'ownerId' in request.resource.data);

      // Atualização:
      // - Admin: pode atualizar tudo
      // - Cliente: apenas seus próprios agendamentos
      allow update: if isAdmin() ||
                       ('ownerId' in resource.data && isOwner(resource.data.ownerId));

      // Deleção:
      // - Admin: pode deletar tudo
      // - Cliente: apenas seus próprios agendamentos
      allow delete: if isAdmin() ||
                       ('ownerId' in resource.data && isOwner(resource.data.ownerId));
    }

    // Regras para dias bloqueados (blockedDates)
    match /blockedDates/{dateId} {
      // Leitura individual (get):
      // - Admin: pode ler tudo
      // - Cliente autenticado: apenas bloqueios com seu ownerId
      // - Público não autenticado: pode ler bloqueios com ownerId
      allow get: if isAdmin() ||
                    (isAuthenticated() && 'ownerId' in resource.data && isOwner(resource.data.ownerId)) ||
                    (!isAuthenticated() && 'ownerId' in resource.data);

      // Leitura de lista (queries):
      // - Admin: pode ler tudo
      // - Cliente autenticado: pode ler bloqueios próprios OU bloqueios públicos (sem ownerId)
      // - Público não autenticado: pode fazer queries limitadas
      // IMPORTANTE: O Firestore Rules valida cada DOCUMENTO retornado
      allow list: if isAdmin() ||
                     (isAuthenticated() &&
                      (resource.data.ownerId == request.auth.uid || !('ownerId' in resource.data))) ||
                     (!isAuthenticated() && request.query.limit <= 100);

      // Criação:
      // - Admin: pode criar com qualquer ownerId ou sem ownerId
      // - Cliente autenticado: pode criar com seu próprio ownerId
      allow create: if isAdmin() ||
                       (isAuthenticated() &&
                        'ownerId' in request.resource.data &&
                        request.resource.data.ownerId == request.auth.uid);

      // Deleção:
      // - Admin: pode deletar tudo
      // - Cliente: apenas seus próprios bloqueios
      allow delete: if isAdmin() ||
                       ('ownerId' in resource.data && isOwner(resource.data.ownerId));
    }

    // Regras para configurações do sistema (opcional - caso adicione no futuro)
    match /settings/{settingId} {
      // Apenas admin pode ler e modificar configurações
      allow read, write: if isAdmin();
    }

    // Regras para usuários (opcional - caso queira guardar dados adicionais)
    match /users/{userId} {
      // Usuário pode ler seus próprios dados ou admin pode ler tudo
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());

      // Usuário pode atualizar seus próprios dados ou admin pode atualizar tudo
      allow update: if isAuthenticated() && (request.auth.uid == userId || isAdmin());

      // Apenas admin pode criar e deletar usuários
      allow create, delete: if isAdmin();
    }

    // Regras para clientes públicos (autenticação customizada)
    match /clients/{clientId} {
      // Qualquer um pode criar uma conta de cliente (registro público)
      allow create: if true;

      // Cliente pode ler e atualizar apenas seus próprios dados
      // Verifica se o documento tem o campo 'phone' e se bate com o clientId
      allow read, update: if clientId == resource.data.phone;

      // Admin pode ler tudo
      allow read: if isAdmin();

      // Ninguém pode deletar (apenas admin via backend)
      allow delete: if isAdmin();
    }
  }
}
