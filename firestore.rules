rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Função helper para verificar se o usuário é admin
    function isAdmin() {
      return request.auth != null && request.auth.uid == 'X7aWBsKSpkTQr25mAigi9DkGULG3';
    }

    // Função helper para verificar se está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Função helper para verificar se o usuário é o dono do recurso
    function isOwner(ownerId) {
      return request.auth != null && request.auth.uid == ownerId;
    }

    // Função helper para verificar se é admin ou dono
    function isAdminOrOwner(ownerId) {
      return isAdmin() || isOwner(ownerId);
    }

    // Regras para agendamentos (bookings)
    match /bookings/{bookingId} {
      // Leitura:
      // - Público: agendamentos sem ownerId (do admin)
      // - Admin: pode ler tudo
      // - Cliente: apenas seus próprios agendamentos (com ownerId)
      allow read: if !('ownerId' in resource.data) ||
                     isAdmin() ||
                     isOwner(resource.data.ownerId);

      // Criação:
      // - Admin: pode criar sem ownerId ou com qualquer ownerId
      // - Cliente autenticado: pode criar com seu próprio ownerId
      // - Público: pode criar agendamentos do admin (sem ownerId)
      allow create: if !('ownerId' in request.resource.data) ||
                       isAdmin() ||
                       (isAuthenticated() && request.resource.data.ownerId == request.auth.uid);

      // Atualização:
      // - Admin: pode atualizar tudo
      // - Cliente: apenas seus próprios agendamentos
      allow update: if isAdmin() ||
                       ('ownerId' in resource.data && isOwner(resource.data.ownerId));

      // Deleção:
      // - Admin: pode deletar tudo
      // - Cliente: apenas seus próprios agendamentos
      allow delete: if isAdmin() ||
                       ('ownerId' in resource.data && isOwner(resource.data.ownerId));
    }

    // Regras para dias bloqueados (blocked_dates)
    match /blocked_dates/{dateId} {
      // Leitura:
      // - Público: datas bloqueadas sem ownerId (do admin)
      // - Admin: pode ler tudo
      // - Cliente: apenas seus próprios bloqueios
      allow read: if !('ownerId' in resource.data) ||
                     isAdmin() ||
                     isOwner(resource.data.ownerId);

      // Criação:
      // - Admin: pode criar sem ownerId ou com qualquer ownerId
      // - Cliente autenticado: pode criar com seu próprio ownerId
      allow create: if isAdmin() ||
                       (isAuthenticated() &&
                        'ownerId' in request.resource.data &&
                        request.resource.data.ownerId == request.auth.uid);

      // Deleção:
      // - Admin: pode deletar tudo
      // - Cliente: apenas seus próprios bloqueios
      allow delete: if isAdmin() ||
                       ('ownerId' in resource.data && isOwner(resource.data.ownerId));
    }

    // Regras para configurações do sistema (opcional - caso adicione no futuro)
    match /settings/{settingId} {
      // Apenas admin pode ler e modificar configurações
      allow read, write: if isAdmin();
    }

    // Regras para usuários (opcional - caso queira guardar dados adicionais)
    match /users/{userId} {
      // Usuário pode ler seus próprios dados ou admin pode ler tudo
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());

      // Usuário pode atualizar seus próprios dados ou admin pode atualizar tudo
      allow update: if isAuthenticated() && (request.auth.uid == userId || isAdmin());

      // Apenas admin pode criar e deletar usuários
      allow create, delete: if isAdmin();
    }
  }
}
